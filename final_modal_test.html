<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Modal Test</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2>üéØ FINAL MODAL HIDE TEST</h2>
        <p>This tests the EXACT modal behavior that will happen in your browser.</p>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Sequence</h5>
                    </div>
                    <div class="card-body">
                        <button id="startTest" class="btn btn-primary btn-lg mb-3">‚ñ∂Ô∏è Start Complete Test</button>
                        <div id="testProgress" class="mb-3">
                            <div class="progress">
                                <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small id="progressText" class="text-muted">Ready to start...</small>
                        </div>
                        <div id="testResult" class="alert alert-info">
                            Click "Start Complete Test" to simulate the exact user experience.
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6>Emergency Controls</h6>
                    </div>
                    <div class="card-body">
                        <button onclick="forceHideModal()" class="btn btn-danger btn-sm mb-2">üö® Force Hide Modal</button>
                        <button onclick="LoadingModal.hide()" class="btn btn-warning btn-sm mb-2">‚ö†Ô∏è Standard Hide</button>
                        <button onclick="resetTest()" class="btn btn-secondary btn-sm">üîÑ Reset</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <h5>Console Output (with timestamps)</h5>
            <div id="console" class="bg-dark text-white p-3 rounded" style="height: 400px; overflow-y: auto; font-family: monospace; font-size: 11px;">
                <div class="text-success">Console ready - waiting for test...</div>
            </div>
        </div>
    </div>

    <!-- Loading Modal (EXACT copy from base.html) -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-body text-center py-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mb-0">Processing document...</p>
                    <small class="text-muted">This may take up to 30 seconds</small>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Console capture with timestamps
        const consoleDiv = document.getElementById('console');
        const originalLog = console.log;
        
        function logWithTime(...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = `[${timestamp}] ${args.join(' ')}`;
            consoleDiv.innerHTML += `<div>${message}</div>`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            originalLog.apply(console, args);
        }
        console.log = logWithTime;

        // EXACT LoadingModal implementation from updated app.js
        const LoadingModal = {
            modal: null,
            modalInstance: null,

            init() {
                if (!this.modal) {
                    this.modal = document.getElementById('loadingModal');
                }
                if (this.modal && !this.modalInstance) {
                    this.modalInstance = new bootstrap.Modal(this.modal, {
                        backdrop: 'static',
                        keyboard: false
                    });
                }
            },

            show(message = 'Processing...') {
                console.log('LoadingModal.show() called with message:', message);
                this.init();
                
                // Update message if modal exists
                if (this.modal) {
                    const modalBody = this.modal.querySelector('.modal-body p.mb-0');
                    if (modalBody) {
                        console.log('Updating modal text to:', message);
                        modalBody.textContent = message;
                    } else {
                        console.log('Could not find modal body element - trying alternative selector');
                        const altModalBody = this.modal.querySelector('.modal-body p');
                        if (altModalBody) {
                            altModalBody.textContent = message;
                            console.log('Updated with alternative selector');
                        }
                    }
                }
                
                // Show modal
                if (this.modalInstance) {
                    console.log('Showing modal');
                    this.modalInstance.show();
                } else {
                    console.log('No modal instance available - trying direct show');
                    if (this.modal) {
                        this.modal.style.display = 'block';
                        this.modal.classList.add('show');
                        document.body.classList.add('modal-open');
                    }
                }
            },

            hide() {
                console.log('LoadingModal.hide() called');
                
                // Multiple hide strategies
                let hidden = false;
                
                // Strategy 1: Use Bootstrap modal instance
                if (this.modalInstance) {
                    console.log('Hiding modal using Bootstrap instance');
                    this.modalInstance.hide();
                    hidden = true;
                }
                
                // Strategy 2: Direct DOM manipulation
                if (this.modal) {
                    console.log('Hiding modal using direct DOM manipulation');
                    this.modal.style.display = 'none';
                    this.modal.classList.remove('show');
                    document.body.classList.remove('modal-open');
                    
                    // Remove backdrop if exists
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) {
                        backdrop.remove();
                    }
                    
                    // Reset body styles
                    document.body.style.paddingRight = '';
                    document.body.style.overflow = '';
                    
                    hidden = true;
                }
                
                // Strategy 3: Try to get existing Bootstrap instance
                if (!hidden && document.getElementById('loadingModal')) {
                    console.log('Trying to get existing Bootstrap modal instance');
                    const existingModal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
                    if (existingModal) {
                        existingModal.hide();
                        hidden = true;
                    }
                }
                
                console.log(`Modal hide completed. Hidden: ${hidden}`);
            }
        };

        // EXACT emergency function from updated upload.js
        window.forceHideModal = function() {
            console.log('üö® Emergency modal hide called');
            
            // Try LoadingModal.hide() first
            try {
                LoadingModal.hide();
                console.log('‚úÖ LoadingModal.hide() called');
            } catch (e) {
                console.log('‚ùå LoadingModal.hide() failed:', e);
            }
            
            // Nuclear option - completely remove modal
            const modalElement = document.getElementById('loadingModal');
            if (modalElement) {
                console.log('üéØ Found modal element, forcing hide...');
                
                // Try Bootstrap instance first
                try {
                    const modalInstance = bootstrap.Modal.getInstance(modalElement);
                    if (modalInstance) {
                        modalInstance.hide();
                        console.log('‚úÖ Bootstrap instance hide called');
                    }
                } catch (e) {
                    console.log('‚ö†Ô∏è  Bootstrap instance hide failed:', e);
                }
                
                // Direct DOM manipulation
                modalElement.style.display = 'none !important';
                modalElement.classList.remove('show', 'fade');
                modalElement.setAttribute('aria-hidden', 'true');
                modalElement.removeAttribute('aria-modal');
                
                console.log('‚úÖ Direct DOM hide applied');
            }
            
            // Remove all modal backdrops
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => {
                backdrop.remove();
                console.log('‚úÖ Backdrop removed');
            });
            
            // Reset body styles
            document.body.classList.remove('modal-open');
            document.body.style.paddingRight = '';
            document.body.style.overflow = '';
            
            // Reset any stuck modals
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
                modal.classList.remove('show');
            });
            
            console.log('üéâ Emergency modal hide completed - page should be interactive now!');
        };

        // Test functions
        function updateProgress(percent, text) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        function updateResult(message, type = 'info') {
            const result = document.getElementById('testResult');
            result.className = `alert alert-${type}`;
            result.innerHTML = message;
        }

        function resetTest() {
            console.log('üîÑ Test reset');
            LoadingModal.hide();
            forceHideModal();
            updateProgress(0, 'Ready to start...');
            updateResult('Click "Start Complete Test" to simulate the exact user experience.');
        }

        async function runCompleteTest() {
            console.log('üß™ ===== STARTING COMPLETE MODAL TEST =====');
            updateResult('üîÑ Running complete test sequence...', 'warning');
            
            // Phase 1: Upload
            console.log('üì§ Phase 1: Simulating file upload...');
            updateProgress(10, 'Uploading file...');
            LoadingModal.show('Uploading document...');
            await sleep(2000);
            
            // Phase 2: Processing
            console.log('üîÑ Phase 2: Processing starts...');
            updateProgress(30, 'Processing document...');
            LoadingModal.show('Processing document...\nThis may take up to 30 seconds.');
            await sleep(2000);
            
            // Phase 3: Analysis
            console.log('üß† Phase 3: Document analysis...');
            updateProgress(60, 'Analyzing document...');
            LoadingModal.show('Analyzing document...\nExtracting text and classifying type.');
            await sleep(2000);
            
            // Phase 4: Completion (THIS IS THE CRITICAL PART)
            console.log('‚úÖ Phase 4: Classification complete - HIDING MODAL');
            updateProgress(90, 'Classification completed!');
            
            // Simulate the completion callback from upload.js
            console.log('Upload completion callback called with status: {status: "completed"}');
            console.log('About to call LoadingModal.hide()');
            LoadingModal.hide();
            
            await sleep(1000);
            
            // Simulate loading results
            console.log('Loading task result...');
            console.log('Forcing modal hide after result loaded');
            LoadingModal.hide(); // Second hide call as backup
            
            updateProgress(100, 'Test completed!');
            
            // Check if modal is actually hidden
            const modalElement = document.getElementById('loadingModal');
            const isVisible = modalElement && (modalElement.style.display !== 'none' && modalElement.classList.contains('show'));
            
            if (isVisible) {
                console.log('‚ùå MODAL STILL VISIBLE - TEST FAILED');
                updateResult('‚ùå TEST FAILED: Modal is still visible. The hide function is not working properly.', 'danger');
            } else {
                console.log('‚úÖ MODAL SUCCESSFULLY HIDDEN - TEST PASSED');
                updateResult('‚úÖ TEST PASSED: Modal was hidden successfully! The fix is working correctly.', 'success');
            }
            
            console.log('üß™ ===== COMPLETE MODAL TEST FINISHED =====');
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            LoadingModal.init();
            
            document.getElementById('startTest').addEventListener('click', runCompleteTest);
            
            console.log('üéØ Final Modal Test initialized');
            console.log('‚úÖ LoadingModal loaded');
            console.log('‚úÖ Emergency functions loaded');
            console.log('üöÄ Ready to test!');
        });
    </script>
</body>
</html>